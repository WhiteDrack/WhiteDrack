
<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jump Pro - Social Update</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #00ff88; --gold: #ffd700; --silver: #c0c0c0; --bronze: #cd7f32; --bg: #0b0f19; --card: #161b22; --text: #f0f6fc; --nav-bg: #1f242d; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; min-height: 100vh; display: flex; flex-direction: column; }
        
        .page { display: none; flex-direction: column; align-items: center; width: 100%; padding: 20px; box-sizing: border-box; flex: 1; overflow-y: auto; padding-bottom: 100px; }
        .active { display: flex; animation: fadeIn 0.3s ease; }

        .card { background: var(--card); padding: 25px; border-radius: 20px; border: 1px solid #30363d; width: 100%; max-width: 400px; text-align: center; }

        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; height: 70px; background: var(--nav-bg); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #30363d; z-index: 1000; }
        .nav-item { background: none; border: none; color: #8b949e; font-size: 11px; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 6px; }
        .nav-item.active-nav { color: var(--primary); }

        .lb-container { width: 100%; max-width: 400px; }
        /* Added cursor pointer to show it's clickable */
        .player-row { display: flex; align-items: center; padding: 12px 15px; background: #21262d; margin-bottom: 8px; border-radius: 12px; border: 1px solid #30363d; animation: fadeIn 0.5s; cursor: pointer; transition: transform 0.1s; }
        .player-row:active { transform: scale(0.98); background: #30363d; }
        
        .rank-circle { width: 30px; height: 30px; background: #30363d; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 15px; color: var(--primary); }
        .player-info { flex-grow: 1; text-align: left; }
        .player-name { font-weight: 600; font-size: 14px; color: #fff; }
        .player-score { font-weight: 800; color: var(--primary); font-size: 16px; }

        .awards-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; margin-top: 15px; }
        .award-card { background: #0d1117; padding: 10px; border-radius: 10px; border: 1px solid #30363d; display: flex; flex-direction: column; align-items: center; }
        .rank-1 { color: var(--gold); border-color: var(--gold); }
        .rank-2 { color: var(--silver); border-color: var(--silver); }
        .rank-3 { color: var(--bronze); border-color: var(--bronze); }
        .rank-top { color: #58a6ff; border-color: #58a6ff; }

        #height { font-size: 80px; font-weight: 900; color: var(--primary); margin: 0; }
        .btn-main { background: var(--primary); color: #000; border: none; padding: 15px; border-radius: 12px; font-weight: 700; width: 100%; cursor: pointer; }
        .season-badge { background: #238636; color: white; padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; margin-bottom: 10px; display: inline-block;}
        .uid-box { background: #0d1117; padding: 10px; border-radius: 8px; font-size: 10px; color: #8b949e; margin-top: 10px; word-break: break-all; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="loginPage" class="page active">
        <div class="card" style="margin-top: 100px;">
            <i class="fas fa-rocket" style="font-size: 50px; color: var(--primary);"></i>
            <h2>Jump Pro</h2>
            <button onclick="login()" class="btn-main" style="margin-top:20px; background:#fff;">Continue with Google</button>
        </div>
    </div>

    <div id="jumpPage" class="page">
        <div class="card">
            <div id="seasonDisplay" class="season-badge">Loading Season...</div>
            <div id="roundDisplay" style="color:#8b949e; font-size:12px; margin-bottom:15px;">Loading...</div>
            <div id="height">0.00</div>
            <div style="color: #484f58; font-size: 12px;">METERS (INSTANT)</div>
            <div id="status" style="margin: 20px 0; color: #e3b341; font-weight: bold;">READY</div>
            <div style="background:#0d1117; padding:10px; border-radius:10px; margin-bottom:20px;">
                <div style="font-size:12px; color:#8b949e;">TODAY'S BEST</div>
                <div id="todayBest" style="font-size:20px; font-weight:bold; color:#fff;">0.00m</div>
            </div>
            <button id="startBtn" class="btn-main">ACTIVATE SENSOR</button>
        </div>
    </div>

    <div id="leaderboardPage" class="page">
        <h2 style="margin-bottom: 5px;"><i class="fas fa-trophy"></i> Global Rank</h2>
        <div style="font-size: 12px; color: #8b949e; margin-bottom: 15px;" id="lbSeasonName">Current Month</div>
        <p style="font-size: 10px; color: #555; margin-top: -10px;">(Tap a player to view profile)</p>
        <div id="lbList" class="lb-container"><p style="color:#555">Waiting for data...</p></div>
    </div>

    <div id="profilePage" class="page">
        <div class="card">
            <img id="pImg" style="width:80px; border-radius:50%; border:2px solid var(--primary);" src="">
            <h2 id="pName" style="margin: 10px 0;">Name</h2>
            <div class="uid-box">UID: <span id="pUid">---</span></div>
            <div style="margin-top: 20px; background: #0d1117; padding: 20px; border-radius: 15px;">
                <span style="font-size:11px; color:#555;">MONTHLY TOTAL</span><br>
                <span id="pTotal" style="font-size:32px; font-weight:800; color:var(--primary);">0.00m</span>
            </div>
            <div style="margin-top: 30px; width: 100%;">
                <h3 style="text-align: left; margin-bottom: 10px; border-bottom: 1px solid #30363d; padding-bottom: 10px;">
                    <i class="fas fa-medal" style="color: #e3b341;"></i> Trophy Case
                </h3>
                <div id="awardsList" class="awards-grid">
                    <p style="grid-column: span 2; color: #555; font-size: 12px;">No awards earned yet.</p>
                </div>
            </div>
            <button onclick="logout()" style="margin-top:20px; background:none; border:none; color:#f85149; cursor:pointer;">Logout</button>
        </div>
    </div>

    <div id="publicProfilePage" class="page" style="z-index: 2000;">
        <div class="card">
            <div style="width:100%; display:flex; justify-content:flex-start;">
                <button onclick="closePublicProfile()" style="background:none; border:none; color:#8b949e; cursor:pointer; display:flex; align-items:center; gap:5px; font-size:14px;">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
            </div>
            
            <img id="ppImg" style="width:80px; border-radius:50%; border:2px solid #58a6ff; margin-top:15px;" src="">
            <h2 id="ppName" style="margin: 10px 0;">Player</h2>
            <div class="uid-box">UID: <span id="ppUid">---</span></div>
            
            <div style="margin-top: 20px; background: #0d1117; padding: 20px; border-radius: 15px; border: 1px solid #30363d;">
                <span style="font-size:11px; color:#555;">MONTHLY SCORE</span><br>
                <span id="ppTotal" style="font-size:32px; font-weight:800; color:#58a6ff;">0.00m</span>
            </div>

            <div style="margin-top: 30px; width: 100%;">
                <h3 style="text-align: left; margin-bottom: 10px; border-bottom: 1px solid #30363d; padding-bottom: 10px;">
                    <i class="fas fa-trophy" style="color: #58a6ff;"></i> Awards
                </h3>
                <div id="ppAwardsList" class="awards-grid">
                    <p style="grid-column: span 2; color: #555; font-size: 12px;">Loading awards...</p>
                </div>
            </div>
        </div>
    </div>

    <nav class="nav-bar" id="bottomNav" style="display:none;">
        <button class="nav-item active-nav" onclick="navTo('jumpPage', this)"><i class="fas fa-bolt"></i><span>JUMP</span></button>
        <button class="nav-item" onclick="navTo('leaderboardPage', this)"><i class="fas fa-chart-line"></i><span>RANK</span></button>
        <button class="nav-item" onclick="navTo('profilePage', this)"><i class="fas fa-user-circle"></i><span>PROFILE</span></button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDOPErXM1g4vdmiVdau67U7vGRsmbtMMhE",
            authDomain: "white-drack-fd1ee.firebaseapp.com",
            databaseURL: "https://white-drack-fd1ee-default-rtdb.firebaseio.com",
            projectId: "white-drack-fd1ee",
            storageBucket: "white-drack-fd1ee.firebasestorage.app",
            messagingSenderId: "151227903888",
            appId: "1:151227903888:web:02a2d7ab14f7d1e152cd15"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const provider = new GoogleAuthProvider();
        let currentUser = null; let todayScore = 0;

        function getSeasonID() {
            const now = new Date();
            return `season_${now.getFullYear()}_${now.getMonth() + 1}`;
        }

        function getSeasonInfo() {
            const now = new Date(); const d = now.getDate();
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const seasonName = `${monthNames[now.getMonth()]} ${now.getFullYear()}`;
            document.getElementById('seasonDisplay').innerText = "Season: " + seasonName;
            document.getElementById('lbSeasonName').innerText = "Leaderboard for " + seasonName;
            let round = 1; if (d > 7) round = 2; if (d > 14) round = 3; if (d > 21) round = 4; if (d > 28) round = "FINAL";
            return { 
                text: round === "FINAL" ? "Finalizing..." : `Round ${round}`, 
                dateKey: `${now.getFullYear()}-${now.getMonth()+1}-${d}`,
                seasonID: getSeasonID()
            };
        }
        document.getElementById('roundDisplay').innerText = getSeasonInfo().text;

        window.login = () => signInWithPopup(auth, provider);
        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('bottomNav').style.display = 'flex';
                loadUserData(user);
                navTo('jumpPage', document.querySelector('.nav-item'));
            } else {
                document.getElementById('bottomNav').style.display = 'none';
                navTo('loginPage');
            }
        });

        window.navTo = (pageId, el) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            if(el) { document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active-nav')); el.classList.add('active-nav'); }
            if(pageId === 'leaderboardPage') loadLeaderboard();
        };

        // --- NEW: View Other Player Functions ---
        window.viewPlayer = (uid) => {
            // Switch to Public Profile Page
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('publicProfilePage').classList.add('active');
            
            // Clear Old Data
            document.getElementById('ppName').innerText = "Loading...";
            document.getElementById('ppUid').innerText = uid;
            document.getElementById('ppTotal').innerText = "...";
            document.getElementById('ppImg').src = "https://via.placeholder.com/80";
            document.getElementById('ppAwardsList').innerHTML = '<p style="grid-column: span 2; color:#555;">Loading...</p>';

            const season = getSeasonInfo().seasonID;

            // Fetch Player Info from Season Node
            onValue(ref(db, `${season}/users/${uid}`), (snap) => {
                if(snap.exists()) {
                    const u = snap.val();
                    document.getElementById('ppName').innerText = u.name;
                    document.getElementById('ppImg').src = u.photo || "https://via.placeholder.com/80";
                    document.getElementById('ppTotal').innerText = parseFloat(u.totalScore || 0).toFixed(2) + "m";
                } else {
                    document.getElementById('ppName').innerText = "Unknown Player";
                    document.getElementById('ppTotal').innerText = "0.00m";
                }
            }, {onlyOnce: true});

            // Fetch Awards
            onValue(ref(db, `users/${uid}/awards`), (snap) => {
                const list = document.getElementById('ppAwardsList');
                if(!snap.exists()) { list.innerHTML = `<p style="grid-column: span 2; color:#555; text-align:center;">No trophies yet.</p>`; return; }
                list.innerHTML = "";
                snap.forEach(c => {
                    const a = c.val(); let rank = parseInt(a.rank);
                    let cls = rank===1?'rank-1':rank===2?'rank-2':rank===3?'rank-3':'rank-top';
                    let icn = rank<=3?'fa-trophy':'fa-medal';
                    list.innerHTML += `<div class="award-card ${cls}"><i class="fas ${icn} ${cls}" style="font-size:24px;"></i><div style="font-weight:bold; color:#fff;">#${rank}</div><div style="font-size:10px; color:#888;">${a.seasonName}</div></div>`;
                });
            }, {onlyOnce: true});
        };

        window.closePublicProfile = () => {
            // Return to Leaderboard
            navTo('leaderboardPage');
            // Restore Leaderboard Nav Highlight
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active-nav'));
            document.querySelectorAll('.nav-item')[1].classList.add('active-nav');
        };

        function loadUserData(user) {
            const season = getSeasonInfo().seasonID;
            document.getElementById('pName').innerText = user.displayName;
            document.getElementById('pImg').src = user.photoURL;
            document.getElementById('pUid').innerText = user.uid;
            
            onValue(ref(db, `${season}/users/${user.uid}/totalScore`), (s) => {
                document.getElementById('pTotal').innerText = (s.exists() ? s.val() : 0).toFixed(2) + "m";
            });
            
            onValue(ref(db, `${season}/daily/${user.uid}/${getSeasonInfo().dateKey}`), (s) => {
                todayScore = s.exists() ? s.val() : 0;
                document.getElementById('todayBest').innerText = todayScore.toFixed(2) + "m";
            });

            onValue(ref(db, `users/${user.uid}/awards`), (snap) => {
                const list = document.getElementById('awardsList');
                if(!snap.exists()) { list.innerHTML = `<p style="grid-column: span 2; color:#555; text-align:center;">No trophies yet.</p>`; return; }
                list.innerHTML = "";
                snap.forEach(c => {
                    const a = c.val(); let rank = parseInt(a.rank);
                    let cls = rank===1?'rank-1':rank===2?'rank-2':rank===3?'rank-3':'rank-top';
                    let icn = rank<=3?'fa-trophy':'fa-medal';
                    list.innerHTML += `<div class="award-card ${cls}"><i class="fas ${icn} ${cls}" style="font-size:24px;"></i><div style="font-weight:bold; color:#fff;">#${rank}</div><div style="font-size:10px; color:#888;">${a.seasonName}</div></div>`;
                });
            });
        }

        async function handleJump(height) {
            if(!currentUser) return;
            const info = getSeasonInfo();
            const season = info.seasonID;

            if (height > todayScore) {
                todayScore = height;
                document.getElementById('todayBest').innerText = height.toFixed(2) + "m";
                await set(ref(db, `${season}/daily/${currentUser.uid}/${info.dateKey}`), height);
                const snap = await get(ref(db, `${season}/daily/${currentUser.uid}`));
                let total = 0; snap.forEach(d => total += d.val());
                await set(ref(db, `${season}/users/${currentUser.uid}`), {
                    name: currentUser.displayName, photo: currentUser.photoURL, totalScore: total
                });
            }
        }

        function loadLeaderboard() {
            const lbList = document.getElementById('lbList');
            lbList.innerHTML = "<p style='text-align:center; color:#888; margin-top:20px;'>Loading Season Data...</p>";
            
            const season = getSeasonInfo().seasonID;
            const dbRef = ref(db, `${season}/users`);
            
            onValue(dbRef, (snapshot) => {
                if (!snapshot.exists()) {
                    lbList.innerHTML = "<p style='text-align:center; margin-top:20px;'>No Players Yet</p>";
                    return;
                }
                
                let players = [];
                snapshot.forEach(child => {
                    const data = child.val();
                    if(data.totalScore) {
                        // IMPORTANT: Save UID to allow profile viewing
                        players.push({ ...data, uid: child.key });
                    }
                });

                players.sort((a, b) => parseFloat(b.totalScore) - parseFloat(a.totalScore));

                let allHtml = "";
                players.slice(0, 50).forEach((p, i) => {
                    let rankStyle = "";
                    let rankColor = "var(--primary)";
                    
                    if(i === 0) { rankStyle = "color:#ffd700; border:1px solid #ffd700; box-shadow: 0 0 5px rgba(255,215,0,0.3);"; rankColor="#ffd700"; }
                    else if(i === 1) { rankStyle = "color:#c0c0c0; border:1px solid #c0c0c0;"; rankColor="#c0c0c0"; }
                    else if(i === 2) { rankStyle = "color:#cd7f32; border:1px solid #cd7f32;"; rankColor="#cd7f32"; }

                    let name = p.name ? p.name.split(' ')[0] : 'Unknown';
                    let score = parseFloat(p.totalScore).toFixed(2);
                    
                    // Added onClick event with UID
                    allHtml += `
                        <div class="player-row" onclick="viewPlayer('${p.uid}')">
                            <div class="rank-circle" style="${rankStyle}">${i+1}</div>
                            <div class="player-info">
                                <span class="player-name">${name}</span>
                            </div>
                            <div class="player-score" style="color:${rankColor}">${score}m</div>
                        </div>`;
                });
                
                lbList.innerHTML = allHtml;

            }, (error) => {
                console.error(error);
                lbList.innerHTML = `<p style='color:red;'>Error: ${error.message}</p>`;
            });
        }

        let isFreeFalling = false; let startTime = 0; let lastAcc = 9.8;
        document.getElementById('startBtn').onclick = function() {
            if (typeof DeviceMotionEvent.requestPermission === 'function') { DeviceMotionEvent.requestPermission().then(s => { if(s=='granted') start(); }); } else { start(); }
            this.innerText = "SENSOR ACTIVE"; this.disabled = true; this.style.background = "#238636";
        };
        function start() {
            window.addEventListener('devicemotion', (e) => {
                let acc = e.accelerationIncludingGravity; if(!acc || !acc.x) return;
                let raw = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);
                lastAcc = (lastAcc * 0.7) + (raw * 0.3);
                let now = performance.now();
                if(lastAcc < 2.5 && !isFreeFalling) { isFreeFalling = true; startTime = now; document.getElementById('status').innerText = "AIRBORNE"; }
                if(isFreeFalling && lastAcc > 14) {
                    let d = (now - startTime)/1000;
                    if(d > 0.2 && d < 2.5) {
                        let h = 0.125 * 9.81 * (d**2);
                        document.getElementById('height').innerText = h.toFixed(2);
                        handleJump(h);
                    }
                    isFreeFalling = false; document.getElementById('status').innerText = "READY";
                }
            });
        }
    </script>
</body>
</html>
