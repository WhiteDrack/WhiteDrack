<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jump Pro - Leaderboard Edition</title>
    <style>
        :root { --primary: #00ff88; --bg: #0b0f19; --card: #161b22; --text: #f0f6fc; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; min-height: 100vh; display: flex; align-items: center; justify-content: center; overflow-x: hidden; }
        
        .page { display: none; flex-direction: column; align-items: center; width: 100%; text-align: center; padding: 20px; box-sizing: border-box; }
        .active { display: flex; }

        .card { background: var(--card); padding: 30px; border-radius: 24px; border: 1px solid #30363d; width: 100%; max-width: 350px; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }

        h1 { color: var(--primary); margin: 0 0 10px 0; font-size: 24px; }
        .btn-google { background: #fff; color: #000; border: none; padding: 14px; border-radius: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; font-size: 16px; }

        /* Tracker UI */
        #height { font-size: 80px; font-weight: 800; color: var(--primary); margin: 10px 0; }
        .unit { font-size: 14px; color: #484f58; text-transform: uppercase; margin-bottom: 20px; }
        
        /* Leaderboard UI */
        .leaderboard-list { text-align: left; margin-top: 20px; width: 100%; }
        .player-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #30363d; font-size: 14px; }
        .player-row:last-child { border: none; }
        .rank { font-weight: bold; color: var(--primary); margin-right: 10px; }
        .score { font-weight: bold; }

        /* Navigation Buttons */
        .nav-btns { margin-top: 20px; display: flex; gap: 10px; width: 100%; max-width: 350px; }
        .btn-nav { flex: 1; background: #30363d; color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-size: 14px; }
        .btn-activate { background: var(--primary); color: #0d1117; border: none; padding: 16px; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; }
        
        #logoutBtn { position: absolute; top: 15px; right: 20px; color: #f85149; background: none; border: none; font-size: 11px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="loginPage" class="page active">
        <div class="card">
            <h1>Jump Pro üöÄ</h1>
            <p>Login to compete in Leaderboard</p>
            <button id="googleBtn" class="btn-google">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/02-google-logo.png" width="18">
                Login with Google
            </button>
        </div>
    </div>

    <div id="trackerPage" class="page">
        <div class="card">
            <button id="logoutBtn">LOGOUT</button>
            <div id="height">0.00</div>
            <div class="unit">Meters High</div>
            <div id="status" style="color:#e3b341; font-size:12px; margin-bottom:15px;">READY</div>
            <button id="startBtn" class="btn-activate">START TRACKER</button>
        </div>
        <div class="nav-btns">
            <button class="btn-nav" onclick="showPage('leaderboardPage')">üèÜ Leaderboard</button>
        </div>
    </div>

    <div id="leaderboardPage" class="page">
        <div class="card">
            <h1>Top 10 Players üèÜ</h1>
            <div id="leaderboardList" class="leaderboard-list">
                <p style="text-align:center; color:#555;">Loading records...</p>
            </div>
            <button class="btn-nav" style="margin-top:20px; width:100%;" onclick="showPage('trackerPage')">Back to Jump</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getDatabase, ref, set, get, query, orderByChild, limitToLast, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDOPErXM1g4vdmiVdau67U7vGRsmbtMMhE",
            authDomain: "white-drack-fd1ee.firebaseapp.com",
            databaseURL: "https://white-drack-fd1ee-default-rtdb.firebaseio.com",
            projectId: "white-drack-fd1ee",
            storageBucket: "white-drack-fd1ee.firebasestorage.app",
            messagingSenderId: "151227903888",
            appId: "1:151227903888:web:02a2d7ab14f7d1e152cd15"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let userBestScore = 0;

        // Navigation
        window.showPage = (pageId) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            if(pageId === 'leaderboardPage') loadLeaderboard();
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                showPage('trackerPage');
                // Check user's previous best
                get(ref(db, 'leaderboard/' + user.uid)).then(snapshot => {
                    if(snapshot.exists()) userBestScore = snapshot.val().score;
                });
            } else {
                showPage('loginPage');
            }
        });

        document.getElementById('googleBtn').onclick = () => signInWithPopup(auth, provider);
        document.getElementById('logoutBtn').onclick = () => signOut(auth);

        // Leaderboard Loading
        function loadLeaderboard() {
            const lbRef = query(ref(db, 'leaderboard'), orderByChild('score'), limitToLast(10));
            onValue(lbRef, (snapshot) => {
                const listDiv = document.getElementById('leaderboardList');
                listDiv.innerHTML = "";
                let players = [];
                snapshot.forEach(child => { players.push(child.val()); });
                players.reverse().forEach((p, index) => {
                    listDiv.innerHTML += `
                        <div class="player-row">
                            <span><span class="rank">#${index+1}</span> ${p.name}</span>
                            <span class="score">${p.score.toFixed(2)}m</span>
                        </div>`;
                });
            });
        }

        // Sensor & Scoring
        let isFreeFalling = false; let startTime = 0; let lastAcc = 9.8;
        document.getElementById('startBtn').onclick = function() {
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission().then(state => { if (state === 'granted') startTracking(); });
            } else { startTracking(); }
            this.disabled = true; this.innerText = "SENSORS ACTIVE";
        };

        function startTracking() {
            window.addEventListener('devicemotion', (e) => {
                let acc = e.accelerationIncludingGravity;
                if (!acc || !acc.x) return;
                let rawAcc = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);
                lastAcc = (lastAcc * 0.7) + (rawAcc * 0.3);
                let now = performance.now();

                if (lastAcc < 2.5 && !isFreeFalling) {
                    isFreeFalling = true; startTime = now;
                    document.getElementById('status').innerText = "AIRBORNE!";
                }

                if (isFreeFalling && lastAcc > 14.0) {
                    let duration = (now - startTime) / 1000;
                    if (duration > 0.2 && duration < 3.0) {
                        let h = 0.125 * 9.81 * Math.pow(duration, 2);
                        document.getElementById('height').innerText = h.toFixed(2);
                        saveScore(h);
                    }
                    isFreeFalling = false;
                }
            });
        }

        function saveScore(score) {
            if (score > userBestScore) {
                userBestScore = score;
                set(ref(db, 'leaderboard/' + currentUser.uid), {
                    name: currentUser.displayName,
                    score: score
                });
                document.getElementById('status').innerText = "NEW PERSONAL BEST! üåü";
            } else {
                document.getElementById('status').innerText = "JUMP RECORDED!";
            }
        }
    </script>
</body>
</html>

