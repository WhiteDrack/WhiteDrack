
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jump Pro - Total Score</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { --primary: #00ff88; --bg: #0b0f19; --card: #161b22; --text: #f0f6fc; --danger: #ff4444; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; user-select: none; }
        
        .page { display: none; flex-direction: column; align-items: center; width: 100%; padding: 20px; box-sizing: border-box; flex: 1; overflow-y: auto; padding-bottom: 100px; }
        .active { display: flex; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: var(--card); padding: 25px; border-radius: 20px; border: 1px solid #30363d; width: 100%; max-width: 400px; text-align: center; margin-bottom: 15px; position: relative; overflow: hidden; }
        
        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; height: 70px; background: rgba(22, 27, 34, 0.95); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #30363d; z-index: 1000; }
        .nav-item { background: none; border: none; color: #8b949e; font-size: 10px; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .nav-item.active-nav { color: var(--primary); }
        .nav-item i { font-size: 22px; }

        .btn-main { background: var(--primary); color: #000; border: none; padding: 15px; border-radius: 12px; font-weight: 800; width: 100%; cursor: pointer; font-size: 16px; margin-top: 10px; }
        #height { font-size: 60px; font-weight: 900; color: #fff; margin: 0; line-height: 1; }
        
        /* Leaderboard Style */
        .player-row { display: flex; align-items: center; padding: 12px; background: #21262d; margin-bottom: 8px; border-radius: 12px; border: 1px solid #30363d; }
        .rank-circle { width: 30px; height: 30px; background: #30363d; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 10px; color: var(--primary); }
        
        select { background: #0d1117; color: #fff; padding: 10px; border-radius: 8px; width: 100%; margin-top: 5px; border: 1px solid #333; }
        
        /* New Stat Box */
        .stat-box { display: flex; justify-content: space-between; margin-top: 10px; background: #0d1117; padding: 10px; border-radius: 10px; }
        .stat-item { text-align: center; width: 48%; }
        .stat-val { font-size: 18px; font-weight: bold; color: #fff; }
        .stat-label { font-size: 10px; color: #888; }

        #safetyModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; }
    </style>
</head>
<body>

    <div id="safetyModal">
        <i class="fas fa-shield-alt" style="font-size: 50px; color: var(--danger); margin-bottom: 20px;"></i>
        <h2>ANTI-CHEAT ACTIVE</h2>
        <p style="color:#ccc;">Phone must <b>SPIN</b> to count.<br>Scores are <b>ADDED</b> (Total Distance).</p>
        <button onclick="document.getElementById('safetyModal').style.display='none'" class="btn-main" style="max-width: 200px;">OK</button>
    </div>

    <div id="loginPage" class="page active">
        <div class="card" style="margin-top: 100px;">
            <i class="fas fa-rocket" style="font-size: 50px; color: var(--primary);"></i>
            <h1>Jump Pro</h1>
            <p style="color:#888;">Build your Total Distance!</p>
            <button onclick="login()" class="btn-main" style="background:#fff; color:#000;">Login with Google</button>
        </div>
    </div>

    <div id="jumpPage" class="page">
        <div class="card">
            <div id="rankDisplay" style="color:#00b8ff; font-weight:bold; margin-bottom:10px;">READY</div>
            
            <div style="font-size:12px; color:#888; margin-bottom:5px;">CURRENT JUMP</div>
            <div id="height">0.00</div>
            
            <div class="stat-box">
                <div class="stat-item">
                    <div class="stat-val" id="totalScoreDisplay" style="color:var(--primary);">0.00m</div>
                    <div class="stat-label">TOTAL SCORE</div>
                </div>
                <div class="stat-item">
                    <div class="stat-val" id="jumpCountDisplay">0</div>
                    <div class="stat-label">JUMPS</div>
                </div>
            </div>

            <div id="msgDisplay" style="font-size:12px; margin-top:10px; color:#666;">Throw to add to total!</div>
            <button id="startBtn" class="btn-main">ACTIVATE SENSOR</button>
            <button id="shareBtn" onclick="shareScore()" class="btn-main" style="background:#333; color:#fff; display:none; margin-top:10px;">Share Total</button>
        </div>
        <div style="font-size:11px; color:#555; margin-top:20px;">Spin: <span id="spinVal">0</span> RPM</div>
    </div>

    <div id="leaderboardPage" class="page">
        <h2 style="margin-bottom:5px;">Top Grinders</h2>
        <p style="font-size:12px; color:#777; margin-bottom:15px;">Ranked by Total Distance</p>
        <div id="lbList" style="width:100%; max-width:400px;">Loading...</div>
    </div>

    <div id="profilePage" class="page">
        <div class="card">
            <img id="pImg" style="width:80px; border-radius:50%; margin-bottom:10px;" src="">
            <h3 id="pName">User</h3>
            
            <div style="text-align:left; margin-bottom:15px;">
                <label style="font-size:12px; color:#888;">Your Flag:</label>
                <select id="countrySelect" onchange="updateCountry()">
                    <option value="üåç">üåç World</option>
                    <option value="üáÆüá≥">üáÆüá≥ India</option>
                    <option value="üá∫üá∏">üá∫üá∏ USA</option>
                    <option value="üá¨üáß">üá¨üáß UK</option>
                </select>
            </div>

            <div style="background:#21262d; padding:15px; border-radius:10px;">
                <div style="font-size:10px; color:#888;">LIFETIME DISTANCE</div>
                <div id="pTotal" style="font-size:30px; font-weight:bold; color:var(--primary);">0.00m</div>
            </div>
            
            <div style="width:100%; height:150px; margin-top:15px;">
                <canvas id="jumpChart"></canvas>
            </div>
            
            <button onclick="logout()" style="color:#ff4444; background:none; border:none; margin-top:20px;">Logout</button>
        </div>
    </div>

    <nav class="nav-bar" id="bottomNav" style="display:none;">
        <button class="nav-item active-nav" onclick="navTo('jumpPage', this)"><i class="fas fa-bolt"></i><span>JUMP</span></button>
        <button class="nav-item" onclick="navTo('leaderboardPage', this)"><i class="fas fa-trophy"></i><span>RANK</span></button>
        <button class="nav-item" onclick="navTo('profilePage', this)"><i class="fas fa-user"></i><span>ME</span></button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getDatabase, ref, set, onValue, update, get } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDOPErXM1g4vdmiVdau67U7vGRsmbtMMhE",
            authDomain: "white-drack-fd1ee.firebaseapp.com",
            databaseURL: "https://white-drack-fd1ee-default-rtdb.firebaseio.com",
            projectId: "white-drack-fd1ee",
            storageBucket: "white-drack-fd1ee.firebasestorage.app",
            messagingSenderId: "151227903888",
            appId: "1:151227903888:web:02a2d7ab14f7d1e152cd15"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        
        let currentUser = null;
        let myTotalScore = 0; // ‚úÖ Now tracking TOTAL
        let myJumpCount = 0;
        let chartInstance = null;
        let sensorActive = false;

        // AUTH
        window.login = () => signInWithPopup(auth, new GoogleAuthProvider());
        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('bottomNav').style.display = 'flex';
                document.getElementById('safetyModal').style.display = 'flex';
                loadUserData(user);
                navTo('jumpPage', document.querySelector('.nav-item'));
            } else {
                document.getElementById('bottomNav').style.display = 'none';
                navTo('loginPage');
            }
        });

        window.navTo = (pageId, el) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            if(el) {
                document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active-nav'));
                el.classList.add('active-nav');
            }
            if(pageId === 'leaderboardPage') loadLeaderboard();
            if(pageId === 'profilePage') renderChart();
        };

        function loadUserData(user) {
            document.getElementById('pName').innerText = user.displayName;
            document.getElementById('pImg').src = user.photoURL;
            onValue(ref(db, 'leaderboard/' + user.uid), (s) => {
                if(s.exists()) {
                    // ‚úÖ LOAD TOTAL SCORE
                    myTotalScore = parseFloat(s.val().score) || 0;
                    myJumpCount = s.val().totalJumps || 0;
                    
                    document.getElementById('pTotal').innerText = myTotalScore.toFixed(2) + "m";
                    document.getElementById('totalScoreDisplay').innerText = myTotalScore.toFixed(2) + "m";
                    document.getElementById('jumpCountDisplay').innerText = myJumpCount;
                    document.getElementById('countrySelect').value = s.val().country || "üåç";
                }
            });
        }
        
        window.updateCountry = () => {
            update(ref(db, 'leaderboard/' + currentUser.uid), { country: document.getElementById('countrySelect').value });
        };

        // --- LEADERBOARD (Sort by Total Score) ---
        function loadLeaderboard() {
            const lbList = document.getElementById('lbList');
            lbList.innerHTML = "<p style='text-align:center; color:#777'>Refreshing...</p>";

            const dbRef = ref(db, 'leaderboard');
            
            onValue(dbRef, (snapshot) => {
                if (!snapshot.exists()) {
                    lbList.innerHTML = "<p style='text-align:center'>No Players Yet</p>";
                    return;
                }
                
                let players = [];
                snapshot.forEach(child => {
                    const data = child.val();
                    if(data.score) players.push(data);
                });

                // Sort: High Total Score to Low
                players.sort((a, b) => parseFloat(b.score) - parseFloat(a.score));

                let allHtml = "";
                players.slice(0, 50).forEach((p, i) => {
                    let rankClass = i < 3 ? 'top-rank' : '';
                    let name = p.name ? p.name.split(' ')[0] : 'Anon';
                    let flag = p.country || "üåç";
                    
                    allHtml += `
                        <div class="player-row">
                            <div class="rank-circle ${rankClass}">${i+1}</div>
                            <div style="flex-grow:1;">${flag} ${name}</div>
                            <div style="font-weight:bold; color:var(--primary);">${parseFloat(p.score).toFixed(2)}m</div>
                        </div>`;
                });
                lbList.innerHTML = allHtml;
            });
        }

        // --- SENSOR ---
        let isFreeFalling = false; let startTime = 0; let lastAcc = 9.8; let maxSpin = 0;
        
        document.getElementById('startBtn').onclick = () => {
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission().then(s => { if(s==='granted') initSensor(); });
            } else { initSensor(); }
        };

        function initSensor() {
            if(sensorActive) return;
            sensorActive = true;
            document.getElementById('startBtn').innerText = "THROW AGAIN";
            document.getElementById('rankDisplay').innerText = "SENSOR ON";

            window.addEventListener('devicemotion', (e) => {
                let acc = e.accelerationIncludingGravity;
                if(!acc) return;
                let raw = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);
                lastAcc = (lastAcc * 0.5) + (raw * 0.5);

                let rot = e.rotationRate;
                if(rot && isFreeFalling) {
                    let totalRot = Math.abs(rot.alpha) + Math.abs(rot.beta) + Math.abs(rot.gamma);
                    maxSpin = Math.max(maxSpin, totalRot);
                }

                if(lastAcc < 2.5 && !isFreeFalling) {
                    isFreeFalling = true; startTime = performance.now(); maxSpin = 0;
                    document.getElementById('rankDisplay').innerText = "FLYING...";
                }

                if(isFreeFalling && lastAcc > 15) {
                    let dur = (performance.now() - startTime) / 1000;
                    if(dur > 0.3 && dur < 3.5) {
                        if(maxSpin < 100) {
                            document.getElementById('rankDisplay').innerText = "FAKE JUMP";
                            document.getElementById('msgDisplay').innerText = "Phone didn't spin!";
                        } else {
                            processJump(dur, maxSpin);
                        }
                    }
                    isFreeFalling = false;
                }
            });
        }

        function processJump(dur, spin) {
            let currentJumpHeight = (9.81 * (dur**2)) / 8;
            
            // ‚úÖ ADD TO TOTAL LOGIC
            let newTotal = myTotalScore + currentJumpHeight;
            let newCount = myJumpCount + 1;

            // UI Update
            document.getElementById('height').innerText = currentJumpHeight.toFixed(2);
            document.getElementById('totalScoreDisplay').innerText = newTotal.toFixed(2) + "m";
            document.getElementById('jumpCountDisplay').innerText = newCount;
            document.getElementById('spinVal').innerText = Math.floor(spin/6);
            document.getElementById('shareBtn').style.display = 'inline-block';
            
            document.getElementById('rankDisplay').innerText = "+ " + currentJumpHeight.toFixed(2) + "m Added!";
            
            // Celebration
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });

            // Save to DB (Always update, because total always increases)
            const refUrl = ref(db, 'leaderboard/' + currentUser.uid);
            get(refUrl).then(s => {
                let hist = s.val()?.history || [];
                hist.unshift(currentJumpHeight);
                if(hist.length > 10) hist.pop();
                
                update(refUrl, {
                    name: currentUser.displayName,
                    score: newTotal, // ‚úÖ Saving Total Score
                    totalJumps: newCount,
                    country: document.getElementById('countrySelect').value,
                    history: hist
                });
                if(chartInstance) updateChart(hist);
            });
        }

        function renderChart() {
            const ctx = document.getElementById('jumpChart').getContext('2d');
            get(ref(db, 'leaderboard/' + currentUser.uid)).then(s => {
                let data = s.val()?.history || [];
                let cData = [...data].reverse();
                if(chartInstance) chartInstance.destroy();
                chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: { labels: cData.map((_, i) => i+1), datasets: [{ label:'Last Jumps', data: cData, borderColor:'#00ff88', tension:0.4 }] },
                    options: { plugins:{legend:{display:false}}, scales:{ x:{display:false}, y:{grid:{color:'#333'}} } }
                });
            });
        }

        window.shareScore = async () => {
             try { await navigator.share({ title: 'Jump Pro', text: `I have a total distance of ${document.getElementById('totalScoreDisplay').innerText} on Jump Pro!`, url: window.location.href }); } catch(e){}
        };
    </script>
</body>
</html>
