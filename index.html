
<!DOCTYPE html>
<html>
<head>
    <title>Real-time Location Share</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map { height: 85vh; width: 100%; border-radius: 10px; }
        .controls { padding: 10px; text-align: center; background: #f4f4f4; }
        #share-link { font-weight: bold; color: blue; word-break: break-all; }
    </style>
</head>
<body>

    <div class="controls">
        <h3 id="status">Location Initialize ho rahi hai...</h3>
        <p>Aapka Sharing Link: <span id="share-link">Loading...</span></p>
    </div>
    <div id="map"></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // 1. Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDOPErXM1g4vdmiVdau67U7vGRsmbtMMhE",
            authDomain: "white-drack-fd1ee.firebaseapp.com",
            databaseURL: "https://white-drack-fd1ee-default-rtdb.firebaseio.com",
            projectId: "white-drack-fd1ee",
            storageBucket: "white-drack-fd1ee.firebasestorage.app",
            messagingSenderId: "151227903888",
            appId: "1:151227903888:web:02a2d7ab14f7d1e152cd15"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // 2. Map Setup
        var map = L.map('map').setView([20.5937, 78.9629], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        var marker = L.marker([0, 0]).addTo(map);

        // 3. Get User ID from URL or Create New
        const urlParams = new URLSearchParams(window.location.search);
        let userId = urlParams.get('id');
        let isViewer = !!userId; // Agar URL mein ID hai toh matlab hum dusre ko dekh rahe hain

        if (!userId) {
            userId = "user-" + Math.floor(Math.random() * 10000);
            const shareUrl = window.location.href.split('?')[0] + "?id=" + userId;
            document.getElementById('share-link').innerText = shareUrl;
            document.getElementById('status').innerText = "Aap apni location bhej rahe hain";
        } else {
            document.getElementById('share-link').innerText = "Aap " + userId + " ko track kar rahe hain";
            document.getElementById('status').innerText = "Tracking Mode";
        }

        // 4. LOGIC: Send or Receive
        if (isViewer) {
            // DUSRE KI LOCATION DEKHNA
            database.ref('locations/' + userId).on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    marker.setLatLng([data.lat, data.lng]).bindPopup("Target Yahan Hai").openPopup();
                    map.setView([data.lat, data.lng], 15);
                }
            });
        } else {
            // APNI LOCATION BHEJNA
            navigator.geolocation.watchPosition((position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                // Update Firebase
                database.ref('locations/' + userId).set({
                    lat: lat,
                    lng: lng,
                    timestamp: Date.now()
                });

                marker.setLatLng([lat, lng]).bindPopup("Aapki Location").openPopup();
                map.setView([lat, lng], 15);
            }, (err) => console.log(err), { enableHighAccuracy: true });
        }
    </script>
</body>
</html>
