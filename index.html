<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jump Pro - Daily Challenge</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { --primary: #00ff88; --secondary: #00b8ff; --bg: #0b0f19; --card: #161b22; --text: #f0f6fc; --danger: #ff4444; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; user-select: none; }
        
        .page { display: none; flex-direction: column; align-items: center; width: 100%; padding: 20px; box-sizing: border-box; flex: 1; overflow-y: auto; padding-bottom: 100px; }
        .active { display: flex; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: var(--card); padding: 25px; border-radius: 20px; border: 1px solid #30363d; width: 100%; max-width: 400px; text-align: center; margin-bottom: 15px; position: relative; overflow: hidden; }
        
        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; height: 70px; background: rgba(22, 27, 34, 0.95); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #30363d; z-index: 1000; }
        .nav-item { background: none; border: none; color: #8b949e; font-size: 10px; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .nav-item.active-nav { color: var(--primary); }
        .nav-item i { font-size: 22px; }

        .btn-main { background: var(--primary); color: #000; border: none; padding: 15px; border-radius: 12px; font-weight: 800; width: 100%; cursor: pointer; font-size: 16px; margin-top: 10px; }
        #height { font-size: 60px; font-weight: 900; color: #fff; margin: 0; line-height: 1; }
        
        .player-row { display: flex; align-items: center; padding: 12px; background: #21262d; margin-bottom: 8px; border-radius: 12px; border: 1px solid #30363d; }
        .rank-circle { width: 30px; height: 30px; background: #30363d; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 10px; color: var(--primary); }
        select { background: #0d1117; color: #fff; padding: 10px; border-radius: 8px; width: 100%; margin-top: 5px; border: 1px solid #333; }
        
        /* Timer Style */
        .timer-badge { background: rgba(255, 68, 68, 0.1); color: #ff4444; padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: bold; display: inline-block; margin-bottom: 15px; border: 1px solid rgba(255, 68, 68, 0.3); }

        #safetyModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; }
    </style>
</head>
<body>

    <div id="safetyModal">
        <i class="fas fa-history" style="font-size: 50px; color: var(--primary); margin-bottom: 20px;"></i>
        <h2>DAILY CHALLENGE</h2>
        <p style="color:#ccc;">Scores RESET every 24 hours.<br>Be the champion of the day!</p>
        <button onclick="document.getElementById('safetyModal').style.display='none'" class="btn-main" style="max-width: 200px;">LET'S GO</button>
    </div>

    <div id="loginPage" class="page active">
        <div class="card" style="margin-top: 100px;">
            <i class="fas fa-rocket" style="font-size: 50px; color: var(--primary);"></i>
            <h1>Jump Pro</h1>
            <p style="color:#888;">Daily Leaderboard Challenge</p>
            <button onclick="login()" class="btn-main" style="background:#fff; color:#000;">Login with Google</button>
        </div>
    </div>

    <div id="jumpPage" class="page">
        <div class="card">
            <div id="timerDisplay" class="timer-badge">Ends in: --:--:--</div>

            <div id="rankDisplay" style="color:#00b8ff; font-weight:bold; margin-bottom:10px;">TODAY'S SCORE</div>
            <div id="height">0.00</div>
            <div style="font-size:12px; color:#888;">METERS</div>
            
            <div style="background:#0d1117; padding:10px; border-radius:10px; margin-top:15px; display:flex; justify-content:space-between;">
                <div>
                    <div style="font-size:10px; color:#888;">TODAY TOTAL</div>
                    <div id="todayTotalDisplay" style="font-size:18px; font-weight:bold; color:var(--primary);">0.00m</div>
                </div>
                <div>
                    <div style="font-size:10px; color:#888;">JUMPS</div>
                    <div id="todayJumpCount">0</div>
                </div>
            </div>

            <button id="startBtn" class="btn-main">ACTIVATE SENSOR</button>
        </div>
        <div style="font-size:11px; color:#555; margin-top:20px;">Spin: <span id="spinVal">0</span> RPM</div>
    </div>

    <div id="leaderboardPage" class="page">
        <h2 style="margin-bottom:5px;">Today's Top 50</h2>
        <div id="lbTimer" style="font-size:12px; color:#ff4444; margin-bottom:15px; font-weight:bold;">Resets in: --:--:--</div>
        <div id="lbList" style="width:100%; max-width:400px;">Loading...</div>
    </div>

    <div id="profilePage" class="page">
        <div class="card">
            <img id="pImg" style="width:80px; border-radius:50%; margin-bottom:10px;" src="">
            <h3 id="pName">User</h3>
            
            <select id="countrySelect" onchange="updateCountry()">
                <option value="üåç">üåç World</option>
                <option value="üáÆüá≥">üáÆüá≥ India</option>
                <option value="üá∫üá∏">üá∫üá∏ USA</option>
            </select>

            <div style="background:#21262d; padding:15px; border-radius:10px; margin-top:15px;">
                <div style="font-size:10px; color:#888;">TODAY'S DISTANCE</div>
                <div id="pToday" style="font-size:30px; font-weight:bold; color:var(--primary);">0.00m</div>
            </div>
            
            <button onclick="logout()" style="color:#ff4444; background:none; border:none; margin-top:20px;">Logout</button>
        </div>
    </div>

    <nav class="nav-bar" id="bottomNav" style="display:none;">
        <button class="nav-item active-nav" onclick="navTo('jumpPage', this)"><i class="fas fa-bolt"></i><span>JUMP</span></button>
        <button class="nav-item" onclick="navTo('leaderboardPage', this)"><i class="fas fa-trophy"></i><span>RANK</span></button>
        <button class="nav-item" onclick="navTo('profilePage', this)"><i class="fas fa-user"></i><span>ME</span></button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getDatabase, ref, set, onValue, update, get } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDOPErXM1g4vdmiVdau67U7vGRsmbtMMhE",
            authDomain: "white-drack-fd1ee.firebaseapp.com",
            databaseURL: "https://white-drack-fd1ee-default-rtdb.firebaseio.com",
            projectId: "white-drack-fd1ee",
            storageBucket: "white-drack-fd1ee.firebasestorage.app",
            messagingSenderId: "151227903888",
            appId: "1:151227903888:web:02a2d7ab14f7d1e152cd15"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        
        let currentUser = null;
        let todayScore = 0;
        let todayJumps = 0;
        let sensorActive = false;

        // --- DATE LOGIC (The Secret Sauce) ---
        // Returns "YYYY-MM-DD" based on UTC to keep everyone in sync
        function getDayId() {
            const now = new Date();
            return now.getUTCFullYear() + "-" + (now.getUTCMonth()+1) + "-" + now.getUTCDate();
        }

        // Countdown Logic
        setInterval(() => {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setUTCDate(now.getUTCDate() + 1);
            tomorrow.setUTCHours(0,0,0,0);
            
            const diff = tomorrow - now;
            const h = Math.floor((diff / (1000 * 60 * 60)) % 24);
            const m = Math.floor((diff / (1000 * 60)) % 60);
            const s = Math.floor((diff / 1000) % 60);
            
            const timeStr = `Ends in: ${h}h ${m}m ${s}s`;
            document.getElementById('timerDisplay').innerText = timeStr;
            document.getElementById('lbTimer').innerText = "Resets in: " + h + "h " + m + "m " + s + "s";
        }, 1000);

        // AUTH
        window.login = () => signInWithPopup(auth, new GoogleAuthProvider());
        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('bottomNav').style.display = 'flex';
                document.getElementById('safetyModal').style.display = 'flex';
                loadUserData(user);
                navTo('jumpPage', document.querySelector('.nav-item'));
            } else {
                document.getElementById('bottomNav').style.display = 'none';
                navTo('loginPage');
            }
        });

        window.navTo = (pageId, el) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            if(el) {
                document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active-nav'));
                el.classList.add('active-nav');
            }
            if(pageId === 'leaderboardPage') loadLeaderboard();
        };

        function loadUserData(user) {
            document.getElementById('pName').innerText = user.displayName;
            document.getElementById('pImg').src = user.photoURL;
            
            // ‚úÖ Load Only TODAY'S Data
            const todayRef = ref(db, 'daily_scores/' + getDayId() + '/' + user.uid);
            
            onValue(todayRef, (s) => {
                if(s.exists()) {
                    todayScore = parseFloat(s.val().score) || 0;
                    todayJumps = s.val().jumps || 0;
                    const country = s.val().country || "üåç";
                    
                    document.getElementById('todayTotalDisplay').innerText = todayScore.toFixed(2) + "m";
                    document.getElementById('pToday').innerText = todayScore.toFixed(2) + "m";
                    document.getElementById('todayJumpCount').innerText = todayJumps;
                    document.getElementById('countrySelect').value = country;
                } else {
                    // New Day = 0 Score
                    todayScore = 0;
                    todayJumps = 0;
                    document.getElementById('todayTotalDisplay').innerText = "0.00m";
                    document.getElementById('pToday').innerText = "0.00m";
                }
            });
        }
        
        window.updateCountry = () => {
            // Update country for Today
            if(currentUser) {
                update(ref(db, 'daily_scores/' + getDayId() + '/' + currentUser.uid), { 
                    country: document.getElementById('countrySelect').value 
                });
            }
        };

        // --- DAILY LEADERBOARD ---
        function loadLeaderboard() {
            const lbList = document.getElementById('lbList');
            lbList.innerHTML = "<p style='text-align:center; color:#777'>Loading Today's Ranks...</p>";

            // ‚úÖ Fetch from 'daily_scores/YYYY-MM-DD'
            const dbRef = ref(db, 'daily_scores/' + getDayId());
            
            onValue(dbRef, (snapshot) => {
                if (!snapshot.exists()) {
                    lbList.innerHTML = "<p style='text-align:center; margin-top:20px;'>No scores today.<br>Be the first!</p>";
                    return;
                }
                
                let players = [];
                snapshot.forEach(child => {
                    const data = child.val();
                    if(data.score) players.push(data);
                });

                players.sort((a, b) => parseFloat(b.score) - parseFloat(a.score));

                let allHtml = "";
                players.slice(0, 50).forEach((p, i) => {
                    let rankClass = i < 3 ? 'top-rank' : '';
                    let name = p.name ? p.name.split(' ')[0] : 'Anon';
                    let flag = p.country || "üåç";
                    
                    allHtml += `
                        <div class="player-row">
                            <div class="rank-circle ${rankClass}">${i+1}</div>
                            <div style="flex-grow:1;">${flag} ${name}</div>
                            <div style="font-weight:bold; color:var(--primary);">${parseFloat(p.score).toFixed(2)}m</div>
                        </div>`;
                });
                lbList.innerHTML = allHtml;
            });
        }

        // --- SENSOR ---
        let isFreeFalling = false; let startTime = 0; let lastAcc = 9.8; let maxSpin = 0;
        
        document.getElementById('startBtn').onclick = () => {
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission().then(s => { if(s==='granted') initSensor(); });
            } else { initSensor(); }
        };

        function initSensor() {
            if(sensorActive) return;
            sensorActive = true;
            document.getElementById('startBtn').innerText = "THROW AGAIN";
            document.getElementById('rankDisplay').innerText = "SENSOR ON";

            window.addEventListener('devicemotion', (e) => {
                let acc = e.accelerationIncludingGravity;
                if(!acc) return;
                let raw = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);
                lastAcc = (lastAcc * 0.5) + (raw * 0.5);

                let rot = e.rotationRate;
                if(rot && isFreeFalling) {
                    let totalRot = Math.abs(rot.alpha) + Math.abs(rot.beta) + Math.abs(rot.gamma);
                    maxSpin = Math.max(maxSpin, totalRot);
                }

                if(lastAcc < 2.5 && !isFreeFalling) {
                    isFreeFalling = true; startTime = performance.now(); maxSpin = 0;
                    document.getElementById('rankDisplay').innerText = "FLYING...";
                }

                if(isFreeFalling && lastAcc > 15) {
                    let dur = (performance.now() - startTime) / 1000;
                    if(dur > 0.3 && dur < 3.5) {
                        if(maxSpin < 100) {
                            document.getElementById('rankDisplay').innerText = "FAKE JUMP";
                        } else {
                            processJump(dur, maxSpin);
                        }
                    }
                    isFreeFalling = false;
                }
            });
        }

        function processJump(dur, spin) {
            let h = (9.81 * (dur**2)) / 8;
            
            // ‚úÖ Add to TODAY'S Score
            let newTotal = todayScore + h;
            let newJumps = todayJumps + 1;

            document.getElementById('height').innerText = h.toFixed(2);
            document.getElementById('todayTotalDisplay').innerText = newTotal.toFixed(2) + "m";
            document.getElementById('todayJumpCount').innerText = newJumps;
            document.getElementById('spinVal').innerText = Math.floor(spin/6);
            
            document.getElementById('rankDisplay').innerText = "+ " + h.toFixed(2) + "m";
            
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });

            // ‚úÖ Save to Date-Specific Path
            update(ref(db, 'daily_scores/' + getDayId() + '/' + currentUser.uid), {
                name: currentUser.displayName,
                score: newTotal,
                jumps: newJumps,
                country: document.getElementById('countrySelect').value
            });
        }
    </script>
</body>
</html>

