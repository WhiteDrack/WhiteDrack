<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jump Pro - Debug Mode</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #00ff88; --bg: #0b0f19; --card: #161b22; --text: #f0f6fc; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; min-height: 100vh; display: flex; flex-direction: column; }
        .page { display: none; flex-direction: column; align-items: center; width: 100%; padding: 20px; flex: 1; }
        .active { display: flex; }
        .card { background: var(--card); padding: 25px; border-radius: 20px; border: 1px solid #30363d; width: 100%; max-width: 400px; text-align: center; }
        .btn-main { background: var(--primary); color: #000; border: none; padding: 15px; border-radius: 12px; font-weight: 700; width: 100%; cursor: pointer; margin-top: 10px;}
        
        /* Leaderboard Styling */
        .player-row { display: flex; align-items: center; padding: 12px; background: #21262d; margin-bottom: 8px; border-radius: 12px; border: 1px solid #30363d; width: 100%; max-width: 400px; }
        .rank-circle { width: 30px; height: 30px; background: #30363d; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 15px; color: var(--primary); }
        .player-name { flex-grow: 1; text-align: left; font-weight: 600; color: #fff; }
        .player-score { font-weight: 800; color: var(--primary); }
    </style>
</head>
<body>

    <div id="loginPage" class="page active">
        <div class="card" style="margin-top: 100px;">
            <h2>Jump Pro</h2>
            <button onclick="login()" class="btn-main" style="background:#fff;">Login with Google</button>
        </div>
    </div>

    <div id="jumpPage" class="page">
        <div class="card">
            <h3>SEASON 1</h3>
            <h1 id="height" style="font-size: 60px; color: var(--primary); margin: 10px 0;">0.00</h1>
            <p>METERS</p>
            <button id="startBtn" class="btn-main">ACTIVATE SENSOR</button>
            <button onclick="navTo('leaderboardPage')" class="btn-main" style="background:#30363d; color:#fff; margin-top:20px;">View Leaderboard</button>
        </div>
    </div>

    <div id="leaderboardPage" class="page">
        <h2>üèÜ Top Rankers</h2>
        <button onclick="navTo('jumpPage')" style="background:none; border:none; color:#888; margin-bottom:20px;">&larr; Back to Jump</button>
        
        <div id="debugStatus" style="color: yellow; font-size: 12px; margin-bottom: 10px;">Checking Database...</div>

        <div id="lbList" style="width: 100%; max-width: 400px;"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDOPErXM1g4vdmiVdau67U7vGRsmbtMMhE",
            authDomain: "white-drack-fd1ee.firebaseapp.com",
            databaseURL: "https://white-drack-fd1ee-default-rtdb.firebaseio.com",
            projectId: "white-drack-fd1ee",
            storageBucket: "white-drack-fd1ee.firebasestorage.app",
            messagingSenderId: "151227903888",
            appId: "1:151227903888:web:02a2d7ab14f7d1e152cd15"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const provider = new GoogleAuthProvider();
        let currentUser = null;

        // Login Logic
        window.login = () => signInWithPopup(auth, provider);
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                navTo('jumpPage');
                // Jaise hi login ho, user ka basic data save karo taaki wo list me aaye
                checkAndCreateUser(user);
            } else {
                navTo('loginPage');
            }
        });

        // Naya User Database me dalne ke liye
        async function checkAndCreateUser(user) {
            const userRef = ref(db, `season_1/users/${user.uid}`);
            const snap = await get(userRef);
            if (!snap.exists()) {
                // Agar user naya hai, to 0 score ke sath add karo
                set(userRef, {
                    name: user.displayName,
                    photo: user.photoURL,
                    totalScore: 0
                });
            }
        }

        window.navTo = (pageId) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            if(pageId === 'leaderboardPage') loadLeaderboard();
        };

        // --- FIXED LEADERBOARD FUNCTION ---
        function loadLeaderboard() {
            const lbList = document.getElementById('lbList');
            const debugText = document.getElementById('debugStatus');
            
            lbList.innerHTML = "";
            debugText.innerText = "Loading data from Firebase...";
            debugText.style.color = "yellow";

            const dbRef = ref(db, 'season_1/users');
            
            onValue(dbRef, (snapshot) => {
                // Check 1: Data hai ya nahi?
                if (!snapshot.exists()) {
                    debugText.innerText = "Database Connected, but EMPTY (No Players).";
                    debugText.style.color = "orange";
                    return;
                }

                debugText.innerText = "Data Received! Processing...";
                debugText.style.color = "#00ff88";

                let players = [];
                snapshot.forEach(child => {
                    const data = child.val();
                    // Score check karo (Number hona chahiye)
                    let score = parseFloat(data.totalScore);
                    if (isNaN(score)) score = 0; // Agar score gadbad hai to 0 maano

                    players.push({
                        name: data.name || "Unknown",
                        score: score
                    });
                });

                // Sorting
                players.sort((a, b) => b.score - a.score);

                // HTML Render
                let html = "";
                players.forEach((p, i) => {
                    html += `
                        <div class="player-row">
                            <div class="rank-circle">${i+1}</div>
                            <div class="player-name">${p.name}</div>
                            <div class="player-score">${p.score.toFixed(2)}m</div>
                        </div>
                    `;
                });
                lbList.innerHTML = html;
                debugText.style.display = "none"; // Sab sahi hai to debug msg hatao

            }, (error) => {
                // Agar Permission Error aaya
                console.error(error);
                debugText.innerText = "ERROR: " + error.message;
                debugText.style.color = "red";
            });
        }

        // --- FAKE DATA GENERATOR (Browser Console mein likho: addFake()) ---
        window.addFake = () => {
            set(ref(db, 'season_1/users/fake_user_1'), { name: "Test Player 1", totalScore: 5.5 });
            set(ref(db, 'season_1/users/fake_user_2'), { name: "Test Player 2", totalScore: 3.2 });
            set(ref(db, 'season_1/users/fake_user_3'), { name: "Test Player 3", totalScore: 8.9 });
            alert("Fake data added! Check leaderboard.");
        };

        // Sensor Logic (Shortened for brevity)
        let isFreeFalling = false; let startTime = 0; let lastAcc = 9.8;
        document.getElementById('startBtn').onclick = function() {
            if (typeof DeviceMotionEvent.requestPermission === 'function') { DeviceMotionEvent.requestPermission().then(s => { if(s=='granted') start(); }); } else { start(); }
        };
        function start() {
            window.addEventListener('devicemotion', (e) => {
                let acc = e.accelerationIncludingGravity; if(!acc) return;
                let raw = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);
                lastAcc = (lastAcc * 0.7) + (raw * 0.3);
                let now = performance.now();
                if(lastAcc < 2.5 && !isFreeFalling) { isFreeFalling = true; startTime = now; }
                if(isFreeFalling && lastAcc > 14) {
                    let d = (now - startTime)/1000;
                    if(d > 0.2 && d < 2.5) {
                        let h = 0.125 * 9.81 * (d**2);
                        document.getElementById('height').innerText = h.toFixed(2);
                        // Save Score
                        if(currentUser) {
                            // Update both daily and total (Simplified logic for test)
                            set(ref(db, `season_1/users/${currentUser.uid}`), {
                                name: currentUser.displayName,
                                photo: currentUser.photoURL,
                                totalScore: h // Direct update for testing
                            });
                        }
                    }
                    isFreeFalling = false;
                }
            });
        }
    </script>
</body>
</html>

