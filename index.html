
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jump Pro X - Analytics</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #00ffcc; --bg: #050505; --card: #111; --text: #fff; --graph-line: #00ffcc; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        .page { display: none; flex-direction: column; align-items: center; width: 100%; padding: 20px; box-sizing: border-box; flex: 1; overflow-y: auto; padding-bottom: 90px; }
        .active { display: flex; animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }

        .card { background: var(--card); padding: 20px; border-radius: 24px; border: 1px solid #222; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 20px 40px rgba(0,255,204,0.05); margin-bottom: 15px; position: relative; }
        
        /* Graph Canvas Styling */
        canvas { width: 100%; height: 120px; background: #0a0a0a; border-radius: 12px; margin-top: 15px; border: 1px solid #333; }

        .btn-main { background: var(--primary); color: #000; border: none; padding: 18px; border-radius: 16px; font-weight: 800; font-size: 16px; width: 100%; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; transition: 0.2s; }
        .btn-main:active { transform: scale(0.95); opacity: 0.8; }

        /* Jump Text */
        #height { font-size: 72px; font-weight: 900; line-height: 1; margin: 10px 0; color: var(--primary); text-shadow: 0 0 20px rgba(0,255,204,0.3); }
        
        /* Leaderboard */
        .player-row { display: flex; align-items: center; padding: 12px; background: #1a1a1a; margin-bottom: 8px; border-radius: 12px; border: 1px solid #2a2a2a; }
        .rank { font-weight: bold; width: 30px; color: #555; }
        .rank.top { color: #ffd700; }
        
        .nav-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 350px; height: 65px; background: rgba(30,30,30,0.8); backdrop-filter: blur(12px); display: flex; justify-content: space-evenly; align-items: center; border-radius: 35px; border: 1px solid #333; z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .nav-item { background: none; border: none; color: #666; font-size: 20px; transition: 0.3s; padding: 10px; border-radius: 50%; }
        .nav-item.active-nav { color: var(--primary); background: rgba(0,255,204,0.1); transform: translateY(-5px); }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="loginPage" class="page active">
        <div class="card" style="margin-top: 100px; border: 1px solid var(--primary);">
            <i class="fas fa-atom" style="font-size: 50px; color: var(--primary); margin-bottom: 20px;"></i>
            <h2>JUMP LABS</h2>
            <p style="color:#777; font-size: 14px;">Advanced Physics Analytics</p>
            <button onclick="login()" class="btn-main" style="margin-top:30px;">Initialize System</button>
        </div>
    </div>

    <div id="jumpPage" class="page">
        <div class="card">
            <div style="display:flex; justify-content:space-between; color:#555; font-size:10px; font-weight:bold; letter-spacing:1px;">
                <span>STATUS: <span id="status" style="color:var(--primary)">IDLE</span></span>
                <span>MODE: PRO</span>
            </div>
            
            <div id="height">0.00</div>
            <div style="font-size: 12px; color: #666; margin-bottom: 20px;">METERS VERTICAL</div>
            
            <canvas id="jumpGraph" width="300" height="100"></canvas>
            <div style="font-size: 10px; color: #444; margin-top: 5px;">G-FORCE VISUALIZATION</div>

            <button id="startBtn" class="btn-main" style="margin-top: 20px;">ARM SENSOR</button>
        </div>

        <div class="card" style="padding: 15px; text-align: left;">
            <div style="font-size: 12px; color: #777; margin-bottom: 10px;">LATEST DATA</div>
            <div id="debugInfo" style="font-size: 11px; font-family: monospace; color: #444;">
                Waiting for jump data...
            </div>
        </div>
    </div>

    <div id="leaderboardPage" class="page">
        <h2 style="margin-bottom:20px;">Global Rankings</h2>
        <div id="lbList" style="width:100%; max-width:400px;">
            <p style="color:#444">Syncing database...</p>
        </div>
    </div>

    <div id="profilePage" class="page">
        <div class="card">
            <img id="pImg" src="" style="width:80px; border-radius:50%; margin-bottom:10px;">
            <h3 id="pName">Pilot</h3>
            <div style="background:#1a1a1a; padding:15px; border-radius:12px; margin-top:15px;">
                <div style="font-size:10px; color:#555;">ALL TIME BEST</div>
                <div id="pBest" style="font-size:30px; font-weight:900; color:var(--primary)">0.00m</div>
            </div>
            <button onclick="logout()" style="margin-top:20px; background:none; border:none; color:#f44; cursor:pointer;">Logout</button>
        </div>
    </div>

    <nav class="nav-bar" id="bottomNav" style="display:none;">
        <button class="nav-item active-nav" onclick="navTo('jumpPage', this)"><i class="fas fa-wave-square"></i></button>
        <button class="nav-item" onclick="navTo('leaderboardPage', this)"><i class="fas fa-list-ol"></i></button>
        <button class="nav-item" onclick="navTo('profilePage', this)"><i class="fas fa-user"></i></button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getDatabase, ref, update, query, orderByChild, limitToLast, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyDOPErXM1g4vdmiVdau67U7vGRsmbtMMhE",
            authDomain: "white-drack-fd1ee.firebaseapp.com",
            databaseURL: "https://white-drack-fd1ee-default-rtdb.firebaseio.com",
            projectId: "white-drack-fd1ee",
            storageBucket: "white-drack-fd1ee.firebasestorage.app",
            messagingSenderId: "151227903888",
            appId: "1:151227903888:web:02a2d7ab14f7d1e152cd15"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let myBest = 0;
        
        // SENSOR VARIABLES
        let sensorActive = false;
        let accData = []; // To store graph data
        let isFreeFalling = false;
        let startTime = 0;
        let lastAcc = 9.8;

        // AUTH
        window.login = () => signInWithPopup(auth, provider);
        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('bottomNav').style.display = 'flex';
                updateProfile(user);
                navTo('jumpPage', document.querySelector('.nav-item'));
            } else {
                document.getElementById('bottomNav').style.display = 'none';
                navTo('loginPage');
            }
        });

        // UI NAVIGATION
        window.navTo = (id, el) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(el) {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active-nav'));
                el.classList.add('active-nav');
            }
        };

        function updateProfile(user) {
            document.getElementById('pName').innerText = user.displayName;
            document.getElementById('pImg').src = user.photoURL;
            onValue(ref(db, 'leaderboard/' + user.uid), s => {
                if(s.exists()) {
                    myBest = s.val().score;
                    document.getElementById('pBest').innerText = myBest.toFixed(2) + "m";
                }
            });
            // Auto load leaderboard to fix caching issues
            loadLeaderboard();
        }

        // --- FIXED LEADERBOARD LOGIC ---
        function loadLeaderboard() {
            const list = document.getElementById('lbList');
            // Using limitToLast(20) to get top scores (Firebase sorts Ascending)
            const q = query(ref(db, 'leaderboard'), orderByChild('score'), limitToLast(20));
            
            onValue(q, (snapshot) => {
                if(!snapshot.exists()) {
                    list.innerHTML = "No Data Found. Check Rules.";
                    return;
                }
                let players = [];
                snapshot.forEach(child => players.push(child.val()));
                
                // CRITICAL: Firebase gives [1, 5, 10]. We need [10, 5, 1].
                players.sort((a,b) => b.score - a.score); 

                list.innerHTML = "";
                players.forEach((p, i) => {
                    let rankStyle = i < 3 ? 'top' : '';
                    let icon = i===0 ? 'ðŸ‘‘' : (i+1);
                    list.innerHTML += `
                        <div class="player-row">
                            <div class="rank ${rankStyle}">${icon}</div>
                            <div style="flex:1; margin-left:10px; font-size:14px; font-weight:500;">
                                ${p.name.split(" ")[0]}
                            </div>
                            <div style="font-weight:bold; color:var(--primary)">
                                ${p.score.toFixed(2)}m
                            </div>
                        </div>
                    `;
                });
            });
        }

        // --- ADVANCED SENSOR & GRAPH LOGIC ---
        
        const canvas = document.getElementById('jumpGraph');
        const ctx = canvas.getContext('2d');

        document.getElementById('startBtn').onclick = () => {
            if(typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission().then(r => { if(r==='granted') initSensor(); });
            } else { initSensor(); }
        };

        function initSensor() {
            if(sensorActive) return;
            sensorActive = true;
            document.getElementById('startBtn').innerText = "LISTENING...";
            document.getElementById('status').innerText = "READY";
            
            window.addEventListener('devicemotion', (e) => {
                let acc = e.accelerationIncludingGravity;
                if(!acc) return;
                
                let raw = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);
                
                // Store data for Graph (Limit to last 100 frames for performance)
                accData.push(raw);
                if(accData.length > 150) accData.shift(); 
                drawGraph(); // Live Draw

                // Smooth Filter
                lastAcc = (lastAcc * 0.5) + (raw * 0.5); 
                let now = performance.now();

                // Logic
                if(lastAcc < 2.5 && !isFreeFalling) {
                    isFreeFalling = true;
                    startTime = now;
                    document.getElementById('status').innerText = "AIRBORNE";
                }

                if(isFreeFalling && lastAcc > 15) {
                    let duration = (now - startTime) / 1000;
                    if(duration > 0.25 && duration < 3.0) {
                        let h = (9.81 * (duration**2)) / 8;
                        finishJump(h, duration);
                    }
                    isFreeFalling = false;
                    document.getElementById('status').innerText = "READY";
                }
            });
        }

        function drawGraph() {
            ctx.fillStyle = '#0a0a0a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.beginPath();
            ctx.strokeStyle = '#00ffcc';
            ctx.lineWidth = 2;
            
            let step = canvas.width / 150;
            
            for(let i=0; i<accData.length; i++) {
                // Map Gravity (0-30) to Canvas Height (100-0)
                let y = 100 - (accData[i] / 30 * 100); 
                if(i===0) ctx.moveTo(i*step, y);
                else ctx.lineTo(i*step, y);
            }
            ctx.stroke();
        }

        function finishJump(h, t) {
            document.getElementById('height').innerText = h.toFixed(2);
            document.getElementById('debugInfo').innerText = `Flight Time: ${t.toFixed(3)}s | Force: ${(lastAcc/9.8).toFixed(1)}G`;
            
            // Speak Result
            if('speechSynthesis' in window) {
                let msg = new SpeechSynthesisUtterance(h.toFixed(2) + " meters");
                window.speechSynthesis.speak(msg);
            }

            if(h > myBest) {
                const updates = {};
                updates['leaderboard/' + currentUser.uid + '/score'] = h;
                updates['leaderboard/' + currentUser.uid + '/name'] = currentUser.displayName;
                update(ref(db), updates);
            }
        }
    </script>
</body>
</html>
